# Решение

## 1. Обязательные компоненты (MUST)

| Компонент            | Обоснование                                                                 | Реализация             |
|----------------------|----------------------------------------------------------------------------|---------------------------------------|
| **Load Balancer**    | Распределение нагрузки между инстансами сервисов. Критично для горизонтального масштабирования чат-сервисов | Nginx Ingress Controller              |
| **CDN**             | Доставка статики (аватары, иконки, медиа в сообщениях) с edge-узлов        | Cloudflare + S3                       |
| **Кэш**            | Уменьшение нагрузки на MongoDB/Greenplum для горячих данных (последние сообщения, сессии) | Redis Cluster (6+ нод)               |
| **IdP**            | Централизованная аутентификация 1M+ игроков с проверкой playerId           | Keycloak с кастомным провайдером Steam|
| **WAF**            | Защита чата от DDoS, инъекций, ботов (особенно важно для игровых сервисов) | Cloudflare WAF + кастомные правила фильтрации чата |
| **CI/CD**          | Автоматизация развертывания 7+ микросервисов                              | GitLab CI: build → security scan (Trivy) → canary deploy в Yandex Cloud |
| **Обзервабилити**  | Мониторинг 1000 RPS сообщений, трейсинг проблем доставки, логи модерации | OpenTelemetry Collector + VictoriaMetrics + Loki + Tempo |
| **Резервное копирование** | Гарантия восстановления чатов (RPO < 1 мин для премиум-игроков)      | WAL-G для Greenplum + ежечасные снапшоты S3 |
| **Message Broker**  | Гарантированная доставка сообщений при пиковых нагрузках                  | Kafka (3 брокера, repl.factor=3)      |
| **Rate Limiter**    | Защита от спама (ограничение сообщений/игрока)                            | Redis Sorted Sets + Lua-скрипты       |

## 2. Рекомендуемые компоненты (SHOULD)

| Компонент            | Обоснование                                                                 | Реализация            |
|----------------------|----------------------------------------------------------------------------|---------------------------------------|
| **Service Mesh**    | Управление трафиком между 7+ сервисами (retries для Notification Service)  | Linkerd (меньше накладных расходов vs Istio) |
| **Geo DNS**        | Маршрутизация EU/NA/ASIA игроков к ближайшим датацентрам                   | GeoDNS → Yandex Cloud (Москва/Амстердам/Сингапур) |
| **Feature Flags**   | Постепенный rollout новых функций чата (например, голосовые сообщения)     | Unleash (self-hosted)                 |
| **API Gateway**     | Единая точка входа для внешних API (Steam/Xbox интеграции)                 | Kong (с плагинами JWT + rate-limiting)|
| **Vector Search**   | Семантический поиск в архивах чатов (поиск по смыслу, а не ключевым словам)| Qdrant (для embedding сообщений)      |
| **A/B Testing**    | Тестирование UX изменений интерфейса чата                                  | Firebase Remote Config                |
| **DLP**            | Защита от утечки персональных данных в чатах                               | Яндекс DLP (сканер сообщений в реальном времени) |
